#!/bin/bash

set -e
ENVIRONMENT=$1
export RAILS_ENV=$1
export RUBBER_ENV=$1

if [ "$ENVIRONMENT" != "production" ]; then
  if [ "$ENVIRONMENT" != "staging" ]; then
    echo "Usage: ./script/deploy (staging|production)"
    exit 1
  fi
fi

solr_push() {
  ENVIRONMENT=$1
  case $ENVIRONMENT in
    staging )
      SOLR_ENV=solr-stage ;;
    production )
      SOLR_ENV=solr-prod ;;
  esac

  if [ -f $HOME/.ssh/alice_rsa.pub ]; then
    echo "Uploading schema.xml to $ENVIRONMENT"
    scp -i $HOME/.ssh/alice_rsa.pub support/schema.xml deploy@ec2-50-112-195-52.us-west-2.compute.amazonaws.com:~/${SOLR_ENV}/conf/schema.xml
    echo "Uploading solrconfig.xml to $ENVIRONMENT"
    scp -i $HOME/.ssh/alice_rsa.pub support/solrconfig.xml deploy@ec2-50-112-195-52.us-west-2.compute.amazonaws.com:~/${SOLR_ENV}/conf/solrconfig.xml
    echo 'Restarting Solr services'
    ssh -i $HOME/.ssh/alice_rsa.pub deploy@ec2-50-112-195-52.us-west-2.compute.amazonaws.com 'sudo service tomcat6 restart'
  else
    echo
    echo 'deploy> ERROR: You need to put alice_rsa.pub in your ~/.ssh directory to deploy solr changes.'
    echo
    exit 1
  fi
}

echo "deploy> Deploying to EC2 ${ENVIRONMENT}"
solr_push $ENVIRONMENT
cap deploy:migrations

echo 'deploy> Warm up request to application'
curl "http://${ENVIRONMENT}.alicelaw.com" &> /dev/null &
